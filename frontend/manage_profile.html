<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Profile</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: auto;
        }
        h1 {
            margin-top: 0;
            font-size: 24px;
        }
        #message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.95em;
            display: none;
        }
        #message.success {
            display: block;
            background: #e6ffed;
            color: #087a3d;
            border: 1px solid #bdf0cb;
        }
        #message.error {
            display: block;
            background: #ffe6e6;
            color: #9a0b0b;
            border: 1px solid #f5bcbc;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .button-group button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
        }
        .edit-button {
            background-color: #007bff;
        }
        .edit-button:hover {
            background-color: #0056b3;
        }
        .delete-button {
            background-color: #dc3545;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        .back {
            margin-top: 20px;
            text-align: center;
        }
        .back a {
            color: #007bff;
            text-decoration: none;
        }
        .back a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Manage Profile</h1>

        <div id="message"></div>
        
        <!-- Table to display staff profiles -->
        <table id="staffTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th style="width: 180px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Staff list will be dynamically inserted here -->
            </tbody>
        </table>
        
        <!-- Back / add link -->
        <div class="back">
            <a href="add_staff_profile.html">Add New Staff</a>
        </div>
    </div>

    <script>
        const API_BASE = "/api"; // change to "http://localhost:5000/api" if frontend hosted separately

        function getToken() {
            return localStorage.getItem("token") || null;
        }

        function showMessage(text, type = "success") {
            const el = document.getElementById("message");
            el.textContent = text;
            el.className = type === "success" ? "success" : "error";
            el.style.display = "block";
            setTimeout(() => { el.style.display = "none"; }, 4000);
        }

        // Normalize staff objects from backend or localStorage
        function normalizeStaff(staff) {
            // backend might send: {id, full_name, user: {email}, ...}
            const name = staff.full_name || staff.name || staff.username || "Unknown";
            const email =
                staff.email ||
                (staff.user && staff.user.email) ||
                staff.contact_email ||
                "";

            return {
                id: staff.id || null,
                name,
                email
            };
        }

        function renderStaffTable(staffList) {
            const tbody = document.querySelector('#staffTable tbody');
            tbody.innerHTML = "";

            if (!staffList.length) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 3;
                cell.textContent = "No staff profiles found.";
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }

            staffList.forEach(staff => {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = staff.name || "";
                row.appendChild(nameCell);

                const emailCell = document.createElement('td');
                emailCell.textContent = staff.email || "";
                row.appendChild(emailCell);

                const actionsCell = document.createElement('td');
                actionsCell.className = 'button-group';
                
                const editButton = document.createElement('button');
                editButton.className = 'edit-button';
                editButton.textContent = 'Edit';
                editButton.onclick = function() {
                    // Prefer id, but also pass email as backup
                    const params = new URLSearchParams();
                    if (staff.id !== null && staff.id !== undefined) {
                        params.append("id", staff.id);
                    }
                    if (staff.email) {
                        params.append("email", staff.email);
                    }
                    window.location.href = `edit_staff_profile.html?${params.toString()}`;
                };
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = function() {
                    deleteProfile(staff);
                };
                actionsCell.appendChild(deleteButton);

                row.appendChild(actionsCell);
                tbody.appendChild(row);
            });
        }

        function readLocalStaff() {
            // Support both old keys: 'staffMembers' and 'staffList'
            let staffMembers = [];
            try {
                const a = JSON.parse(localStorage.getItem('staffMembers') || "[]");
                const b = JSON.parse(localStorage.getItem('staffList') || "[]");
                staffMembers = [...a, ...b];
            } catch (e) {
                staffMembers = [];
            }
            return staffMembers.map(normalizeStaff);
        }

        async function loadStaffProfiles() {
            let staffList = [];

            // Try backend first
            try {
                const headers = {};
                const token = getToken();
                if (token) headers["Authorization"] = `Bearer ${token}`;

                const resp = await fetch(`${API_BASE}/staff/`, { headers });
                if (!resp.ok) throw new Error("Bad response from backend");
                const data = await resp.json();
                if (Array.isArray(data)) {
                    staffList = data.map(normalizeStaff);
                }

                // cache in localStorage for offline use
                try {
                    const cache = staffList.map(s => ({ id: s.id, name: s.name, email: s.email }));
                    localStorage.setItem("staffMembers", JSON.stringify(cache));
                } catch (e) {
                    console.warn("Could not cache staffMembers:", e);
                }
            } catch (err) {
                console.warn("Could not load staff from backend, falling back to localStorage:", err);
                staffList = readLocalStaff();
            }

            renderStaffTable(staffList);
        }

        async function deleteProfile(staff) {
            if (!confirm('Are you sure you want to delete this profile?')) return;

            const { id, email } = staff;

            // Helper: update localStorage
            function deleteFromLocalStorage() {
                const keys = ['staffMembers', 'staffList'];
                keys.forEach(key => {
                    try {
                        let list = JSON.parse(localStorage.getItem(key) || "[]");
                        list = list.filter(s => s.email !== email && String(s.id) !== String(id));
                        localStorage.setItem(key, JSON.stringify(list));
                    } catch (e) {
                        // ignore
                    }
                });
            }

            // If we have an id, try backend delete
            if (id !== null && id !== undefined) {
                try {
                    const headers = {};
                    const token = getToken();
                    if (token) headers["Authorization"] = `Bearer ${token}`;

                    const resp = await fetch(`${API_BASE}/staff/${id}`, {
                        method: "DELETE",
                        headers
                    });

                    if (!resp.ok) {
                        const data = await resp.json().catch(() => ({}));
                        const err = data.msg || data.error || `Server responded with ${resp.status}`;
                        showMessage("Error deleting staff: " + err, "error");
                        return;
                    }

                    deleteFromLocalStorage();
                    showMessage("Staff profile deleted successfully.", "success");
                    loadStaffProfiles();
                    return;
                } catch (err) {
                    console.error("Network error deleting staff, falling back to local-only delete:", err);
                    // fall through to local-only
                }
            }

            // If no id or backend failed, delete locally only
            deleteFromLocalStorage();
            showMessage("Staff profile deleted locally.", "success");
            loadStaffProfiles();
        }

        window.onload = loadStaffProfiles;
    </script>
</body>
</html>
