<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Subjects</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: auto;
        }
        h1 {
            margin-top: 0;
            font-size: 24px;
        }
        #message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.95em;
            display: none;
        }
        #message.success {
            display: block;
            background: #e6ffed;
            color: #087a3d;
            border: 1px solid #bdf0cb;
        }
        #message.error {
            display: block;
            background: #ffe6e6;
            color: #9a0b0b;
            border: 1px solid #f5bcbc;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: #fff;
        }
        .back-button {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
        }
        .back-button:hover {
            background-color: #0056b3;
        }
        .action-button {
            display: inline-block;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            margin-right: 5px;
        }
        .edit-button {
            background-color: #ffc107;
            color: #000;
        }
        .edit-button:hover {
            background-color: #e0a800;
        }
        .delete-button {
            background-color: #dc3545;
            color: #fff;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        #noSubjects {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
    </style>
    <script>
        const API_BASE = "/api"; // change to "http://localhost:5000/api" if needed
        let currentSubjects = []; // {id, name, course, staff, _source, localIndex}

        function getToken() {
            return localStorage.getItem("token") || null;
        }

        function showMessage(text, type = "success") {
            const el = document.getElementById("message");
            el.textContent = text;
            el.className = type === "success" ? "success" : "error";
            el.style.display = "block";
            setTimeout(() => { el.style.display = "none"; }, 4000);
        }

        function normalizeSubject(subj, indexFromLocal = null, source = "server") {
            if (source === "local") {
                return {
                    id: subj.id || null,
                    name: subj.name || "Untitled",
                    course: subj.course || subj.course_name || "",
                    staff: subj.staff || subj.staff_name || "",
                    _source: source,
                    localIndex: indexFromLocal
                };
            }

            // server object might look like: { id, name, course: {name}, staff: {full_name}, ... }
            const name = subj.name || "Untitled";
            const courseName =
                (subj.course && (subj.course.name || subj.course.code)) ||
                subj.course_name ||
                "";
            const staffName =
                (subj.staff && (subj.staff.full_name || subj.staff.name)) ||
                subj.staff_name ||
                "";
            return {
                id: subj.id || null,
                name,
                course: courseName,
                staff: staffName,
                _source: source,
                localIndex: indexFromLocal
            };
        }

        function renderSubjects() {
            const tbody = document.getElementById('subjectsTableBody');
            const noSubjects = document.getElementById('noSubjects');
            tbody.innerHTML = '';

            if (!currentSubjects.length) {
                if (noSubjects) noSubjects.style.display = 'block';
                return;
            }
            if (noSubjects) noSubjects.style.display = 'none';

            currentSubjects.forEach((subject, index) => {
                const row = document.createElement('tr');

                const cellSubject = document.createElement('td');
                cellSubject.textContent = subject.name;
                row.appendChild(cellSubject);

                const cellCourse = document.createElement('td');
                cellCourse.textContent = subject.course || "";
                row.appendChild(cellCourse);

                const cellStaff = document.createElement('td');
                cellStaff.textContent = subject.staff || "";
                row.appendChild(cellStaff);

                const cellActions = document.createElement('td');

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.className = 'action-button edit-button';
                editButton.onclick = function() {
                    editSubject(index);
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'action-button delete-button';
                deleteButton.onclick = function() {
                    deleteSubject(index);
                };

                cellActions.appendChild(editButton);
                cellActions.appendChild(deleteButton);
                row.appendChild(cellActions);

                tbody.appendChild(row);
            });
        }

        function readLocalSubjects() {
            try {
                const subs = JSON.parse(localStorage.getItem('subjects') || "[]");
                return subs.map((s, idx) => normalizeSubject(s, idx, "local"));
            } catch (e) {
                return [];
            }
        }

        async function loadSubjects() {
            currentSubjects = [];

            // Try backend first
            try {
                const headers = {};
                const token = getToken();
                if (token) headers["Authorization"] = `Bearer ${token}`;

                const resp = await fetch(`${API_BASE}/subjects/`, { headers });
                if (!resp.ok) throw new Error("Bad response from backend");
                const data = await resp.json();

                if (Array.isArray(data)) {
                    currentSubjects = data.map(s => normalizeSubject(s, null, "server"));
                }

                // Cache simplified copy locally
                try {
                    const cache = currentSubjects.map(s => ({
                        id: s.id,
                        name: s.name,
                        course: s.course,
                        staff: s.staff
                    }));
                    localStorage.setItem("subjects", JSON.stringify(cache));
                } catch (e) {
                    console.warn("Could not cache subjects:", e);
                }
            } catch (err) {
                console.warn("Could not load subjects from backend, falling back to localStorage:", err);
                currentSubjects = readLocalSubjects();
            }

            renderSubjects();
        }

        async function editSubject(index) {
            const subject = currentSubjects[index];
            if (!subject) return;

            const newName = prompt('Enter new subject name:', subject.name);
            if (!newName || !newName.trim()) return;

            // helper: update localStorage
            function updateLocalStorageName() {
                try {
                    const stored = JSON.parse(localStorage.getItem('subjects') || "[]");
                    let updated;
                    if (typeof subject.localIndex === "number") {
                        updated = stored.map((s, idx) => {
                            if (idx === subject.localIndex) {
                                return { ...s, name: newName };
                            }
                            return s;
                        });
                    } else {
                        // fallback by name+course+staff match
                        updated = stored.map(s => {
                            const n = s.name || "";
                            const c = s.course || s.course_name || "";
                            const st = s.staff || s.staff_name || "";
                            if (n === subject.name && c === subject.course && st === subject.staff) {
                                return { ...s, name: newName };
                            }
                            return s;
                        });
                    }
                    localStorage.setItem("subjects", JSON.stringify(updated));
                } catch (e) {
                    console.warn("Failed to update subjects in localStorage:", e);
                }
            }

            // Try backend PUT if id exists
            if (subject.id !== null && subject.id !== undefined) {
                try {
                    const headers = { "Content-Type": "application/json" };
                    const token = getToken();
                    if (token) headers["Authorization"] = `Bearer ${token}`;

                    const resp = await fetch(`${API_BASE}/subjects/${subject.id}`, {
                        method: "PUT",
                        headers,
                        body: JSON.stringify({ name: newName })
                    });

                    if (!resp.ok) {
                        const data = await resp.json().catch(() => ({}));
                        const err = data.msg || data.error || `Server responded with ${resp.status}`;
                        showMessage("Error updating subject: " + err, "error");
                        return;
                    }

                    subject.name = newName;
                    updateLocalStorageName();
                    renderSubjects();
                    showMessage("Subject updated successfully.", "success");
                    return;
                } catch (err) {
                    console.error("Network error while updating subject, falling back to local-only edit:", err);
                    // fall through to local-only
                }
            }

            // Local-only update
            subject.name = newName;
            updateLocalStorageName();
            renderSubjects();
            showMessage("Subject updated locally.", "success");
        }

        async function deleteSubject(index) {
            const subject = currentSubjects[index];
            if (!subject) return;

            if (!confirm('Are you sure you want to delete this subject?')) return;

            // helper: delete from localStorage
            function deleteFromLocalStorage() {
                try {
                    const stored = JSON.parse(localStorage.getItem('subjects') || "[]");
                    let updated;
                    if (typeof subject.localIndex === "number") {
                        updated = stored.filter((_, idx) => idx !== subject.localIndex);
                    } else {
                        updated = stored.filter(s => {
                            const n = s.name || "";
                            const c = s.course || s.course_name || "";
                            const st = s.staff || s.staff_name || "";
                            return !(n === subject.name && c === subject.course && st === subject.staff);
                        });
                    }
                    localStorage.setItem("subjects", JSON.stringify(updated));
                } catch (e) {
                    console.warn("Failed to update localStorage subjects:", e);
                }
            }

            // Try backend delete if id exists
            if (subject.id !== null && subject.id !== undefined) {
                try {
                    const headers = {};
                    const token = getToken();
                    if (token) headers["Authorization"] = `Bearer ${token}`;

                    const resp = await fetch(`${API_BASE}/subjects/${subject.id}`, {
                        method: "DELETE",
                        headers
                    });

                    if (!resp.ok) {
                        const data = await resp.json().catch(() => ({}));
                        const err = data.msg || data.error || `Server responded with ${resp.status}`;
                        showMessage("Error deleting subject: " + err, "error");
                        return;
                    }

                    deleteFromLocalStorage();
                    currentSubjects.splice(index, 1);
                    renderSubjects();
                    showMessage("Subject deleted successfully.", "success");
                    return;
                } catch (err) {
                    console.error("Network error deleting subject, falling back to local-only delete:", err);
                    // fall through to local-only
                }
            }

            // Local-only delete
            deleteFromLocalStorage();
            currentSubjects.splice(index, 1);
            renderSubjects();
            showMessage("Subject deleted locally.", "success");
        }

        function goBack() {
            window.location.href = 'admin_dashboard.html';
        }

        window.onload = loadSubjects;
    </script>
</head>
<body>
    <div class="container">
        <h1>Manage Subjects</h1>

        <div id="message"></div>

        <table>
            <thead>
                <tr>
                    <th>Subject Name</th>
                    <th>Course Name</th>
                    <th>Staff Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="subjectsTableBody">
                <!-- Rows will be populated here by JavaScript -->
            </tbody>
        </table>

        <p id="noSubjects" style="display:none;">No subjects found.</p>

        <button class="back-button" onclick="goBack()">Go Back to Admin Dashboard</button>
    </div>
</body>
</html>
